<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LFG Bridge - Найди тиммейтов</title>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
        }

        body {
            background-color: #0f0f23;
            color: #e6e6e6;
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 70px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

            .screen.active {
                display: block;
            }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        h1, h2, h3 {
            color: #6ab7ff;
            margin-bottom: 15px;
            font-weight: 600;
        }

        h1 {
            font-size: 28px;
            text-align: center;
            margin-bottom: 30px;
        }

        h2 {
            font-size: 22px;
        }

        .card {
            background-color: #1a1a2e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid #2a2a3e;
        }

        .btn {
            display: inline-block;
            background-color: #2d7bd4;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 14px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: all 0.2s ease;
            margin: 5px;
            width: calc(100% - 10px);
        }

            .btn:hover {
                background-color: #3a8be8;
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            }

            .btn:active {
                transform: translateY(0);
            }

        .btn-secondary {
            background-color: #4a4a6a;
        }

            .btn-secondary:hover {
                background-color: #5a5a7a;
            }

        .btn-success {
            background-color: #2e7d32;
        }

            .btn-success:hover {
                background-color: #3d8b40;
            }

        .btn-danger {
            background-color: #c62828;
        }

            .btn-danger:hover {
                background-color: #d32f2f;
            }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

            .button-group .btn {
                flex: 1;
                margin: 0;
            }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

            .step-indicator::before {
                content: '';
                position: absolute;
                top: 15px;
                left: 0;
                right: 0;
                height: 2px;
                background-color: #4a4a6a;
                z-index: 1;
            }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2;
            position: relative;
            flex: 1;
        }

        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #4a4a6a;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            border: 3px solid #1a1a2e;
        }

        .step.active .step-circle {
            background-color: #2d7bd4;
        }

        .step.completed .step-circle {
            background-color: #2e7d32;
        }

        .step-label {
            font-size: 12px;
            text-align: center;
            color: #aaa;
        }

        .step.active .step-label {
            color: #6ab7ff;
        }

        .options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .option {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            background-color: #2a2a3e;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

            .option:hover {
                background-color: #3a3a4e;
            }

            .option.selected {
                background-color: #1e3a5f;
                border-color: #2d7bd4;
                color: #6ab7ff;
            }

        .player-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .player-card {
            background-color: #2a2a3e;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }

            .player-card:hover {
                background-color: #3a3a4e;
                transform: translateY(-2px);
            }

        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #4a4a6a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            margin-right: 15px;
            color: #6ab7ff;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .player-details {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 14px;
            color: #aaa;
        }

        .player-detail {
            background-color: #1a1a2e;
            padding: 3px 8px;
            border-radius: 12px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #1a1a2e;
            border-top: 1px solid #2a2a3e;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #aaa;
            text-decoration: none;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

            .nav-item:hover {
                background-color: #2a2a3e;
            }

            .nav-item.active {
                color: #6ab7ff;
            }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

            .status.success {
                background-color: rgba(46, 125, 50, 0.2);
                color: #81c784;
                border: 1px solid #2e7d32;
            }

            .status.info {
                background-color: rgba(33, 150, 243, 0.2);
                color: #64b5f6;
                border: 1px solid #2196f3;
            }

            .status.warning {
                background-color: rgba(255, 152, 0, 0.2);
                color: #ffb74d;
                border: 1px solid #ff9800;
            }

            .status.error {
                background-color: rgba(211, 47, 47, 0.2);
                color: #ef5350;
                border: 1px solid #d32f2f;
            }

        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(106, 183, 255, 0.3);
            border-radius: 50%;
            border-top-color: #6ab7ff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none;
        }

        .welcome-screen {
            text-align: center;
            padding-top: 40px;
        }

        .welcome-icon {
            font-size: 64px;
            margin-bottom: 20px;
            color: #6ab7ff;
        }

        .welcome-text {
            font-size: 18px;
            margin-bottom: 30px;
            color: #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Экран приветствия -->
        <div id="welcome-screen" class="screen active">
            <div class="welcome-screen">
                <div class="welcome-icon">🎮</div>
                <h1>LFG Bridge - Найди тиммейтов</h1>
                <p class="welcome-text">Найди идеальных тиммейтов для совместной игры в Dota 2, CS:GO и Valorant</p>
                <div class="card">
                    <p>Создай анкету, чтобы другие игроки могли найти тебя по твоим предпочтениям и уровню игры.</p>
                    <button id="start-btn" class="btn">Начать поиск тиммейтов</button>
                </div>
            </div>
        </div>

        <!-- Экран анкеты -->
        <div id="form-screen" class="screen">
            <h2>📝 Создание анкеты</h2>

            <div class="step-indicator">
                <div class="step active" id="step-1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Игра</div>
                </div>
                <div class="step" id="step-2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Ранг</div>
                </div>
                <div class="step" id="step-3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Роль</div>
                </div>
                <div class="step" id="step-4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Цель</div>
                </div>
            </div>

            <!-- Шаг 1: Выбор игры -->
            <div id="form-step-1" class="form-step">
                <div class="card">
                    <h3>🎮 Выберите игру</h3>
                    <p>В какую игру вы ищете тиммейтов?</p>
                    <div class="options">
                        <div class="option" data-value="dota2">Dota 2</div>
                        <div class="option" data-value="csgo">CS:GO</div>
                        <div class="option" data-value="valorant">Valorant</div>
                    </div>
                </div>
            </div>

            <!-- Шаг 2: Выбор ранга -->
            <div id="form-step-2" class="form-step hidden">
                <div class="card">
                    <h3>🏆 Ваш уровень игры</h3>
                    <p>Выберите свой ранг или уровень</p>
                    <div class="options" id="rank-options">
                        <div class="status warning">Сначала выберите игру на шаге 1</div>
                    </div>
                </div>
            </div>

            <!-- Шаг 3: Выбор роли -->
            <div id="form-step-3" class="form-step hidden">
                <div class="card">
                    <h3>👤 Предпочитаемая роль</h3>
                    <p>Какую роль вы обычно играете?</p>
                    <div class="options" id="role-options">
                        <div class="status warning">Сначала выберите игру на шаге 1</div>
                    </div>
                </div>
            </div>

            <!-- Шаг 4: Цель игры -->
            <div id="form-step-4" class="form-step hidden">
                <div class="card">
                    <h3>🎯 Цель игры</h3>
                    <p>С какой целью вы ищете тиммейтов?</p>
                    <div class="options">
                        <div class="option" data-value="ranked">Ранговые игры</div>
                        <div class="option" data-value="fun">Для развлечения</div>
                        <div class="option" data-value="training">Обучение/тренировка</div>
                        <div class="option" data-value="tournament">Турниры/соревнования</div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button id="prev-step-btn" class="btn btn-secondary hidden">Назад</button>
                <button id="next-step-btn" class="btn">Далее</button>
            </div>
        </div>

        <!-- Экран поиска -->
        <div id="search-screen" class="screen">
            <h2>🔍 Поиск тиммейтов</h2>

            <div class="card">
                <p>Нажмите кнопку ниже, чтобы найти игроков с похожими предпочтениями.</p>

                <div id="search-status" class="status info hidden">
                    <span class="loader"></span> Идет поиск тиммейтов...
                </div>

                <div id="search-results" class="player-list"></div>

                <button id="search-btn" class="btn btn-success">Найти тиммейтов</button>
                <button id="refresh-search-btn" class="btn btn-secondary">Обновить результаты</button>
            </div>
        </div>

        <!-- Экран профиля -->
        <div id="profile-screen" class="screen">
            <h2>👤 Мой профиль</h2>

            <div class="card">
                <div id="profile-info">
                    <p class="status info">У вас еще нет созданной анкеты. Заполните анкету на вкладке "Анкета".</p>
                </div>

                <div class="button-group">
                    <button id="edit-profile-btn" class="btn hidden">Редактировать анкету</button>
                    <button id="delete-profile-btn" class="btn btn-danger hidden">Удалить анкету</button>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <a href="#" class="nav-item" data-screen="search-screen">
            <div class="nav-icon">🔍</div>
            <div>Поиск</div>
        </a>
        <a href="#" class="nav-item" data-screen="form-screen">
            <div class="nav-icon">📝</div>
            <div>Анкета</div>
        </a>
        <a href="#" class="nav-item" data-screen="profile-screen">
            <div class="nav-icon">👤</div>
            <div>Профиль</div>
        </a>
    </div>

    <script>
        // ==============================================
        // КОНФИГУРАЦИЯ БАЗЫ ДАННЫХ
        // ==============================================

        // Готовая база данных на Sheet.best
        // Структура таблицы:
        // A: Имя | B: Игра | C: Ранг | D: Роль | E: Цель | F: Telegram | G: Дата создания
        const SHEET_BEST_API = {
            // Только для чтения (получить всех игроков)
            READ_URL: 'https://api.sheetbest.com/sheets/cae892b3-3254-427a-8910-7b037af1335e',

            // Для записи (добавить нового игрока)
            WRITE_URL: 'https://sheet.best/api/sheets/cae892b3-3254-427a-8910-7b037af1335e'
        };

        // Хранилище для проверки дубликатов
        const playerDuplicates = new Set();

        // Текущие данные пользователя
        let userProfile = {
            game: null,
            rank: null,
            role: null,
            goal: null,
            name: "Игрок",
            telegram: "",
            userId: null,
            createdAt: null
        };

        // Текущий шаг анкеты
        let currentStep = 1;
        const totalSteps = 4;

        // Данные для анкеты
        const gameData = {
            dota2: {
                name: "Dota 2",
                ranks: ["Herald", "Guardian", "Crusader", "Archon", "Legend", "Ancient", "Divine", "Immortal"],
                roles: ["Керри", "Мид", "Оффлейнер", "Семисупора", "Саппорт", "Роумер"]
            },
            csgo: {
                name: "CS:GO",
                ranks: ["Silver I", "Silver II", "Silver III", "Silver IV", "Silver Elite", "Silver Elite Master",
                       "Gold Nova I", "Gold Nova II", "Gold Nova III", "Gold Nova Master",
                       "Master Guardian I", "Master Guardian II", "Master Guardian Elite",
                       "Distinguished Master Guardian", "Legendary Eagle", "Legendary Eagle Master",
                       "Supreme Master First Class", "Global Elite"],
                roles: ["Снайпер", "Рифлер", "Энтри", "Капитан", "Стратег", "Флекc"]
            },
            valorant: {
                name: "Valorant",
                ranks: ["Iron", "Bronze", "Silver", "Gold", "Platinum", "Diamond", "Ascendant", "Immortal", "Radiant"],
                roles: ["Дуэлянт", "Инициатор", "Контроллер", "Страж"]
            }
        };

        // ==============================================
        // ФУНКЦИИ ДЛЯ РАБОТЫ С БАЗОЙ ДАННЫХ
        // ==============================================

        // Получить всех игроков из базы данных с фильтрацией дубликатов
        async function getAllPlayers() {
            try {
                console.log("Загружаю данные из базы...");
                const response = await fetch(SHEET_BEST_API.READ_URL);

                if (!response.ok) {
                    throw new Error(`Ошибка загрузки: ${response.status}`);
                }

                const data = await response.json();
                console.log("Данные загружены:", data.length, "записей");

                // Фильтруем дубликаты по Telegram username
                const uniquePlayers = removeDuplicates(data);
                console.log("После фильтрации дубликатов:", uniquePlayers.length, "уникальных игроков");

                return uniquePlayers;
            } catch (error) {
                console.error("Ошибка при загрузке игроков:", error);
                showMessage("⚠️ Не удалось загрузить данные. Попробуйте позже.", "warning");
                return [];
            }
        }

        // Удалить дубликаты из массива игроков
        function removeDuplicates(players) {
            const uniquePlayers = [];
            const seenTelegrams = new Set();

            for (const player of players) {
                // Используем Telegram username как уникальный идентификатор
                const telegram = player.Telegram || player['Telegram username'] || player['Telegram'] || '';

                if (telegram && !seenTelegrams.has(telegram.toLowerCase())) {
                    seenTelegrams.add(telegram.toLowerCase());
                    uniquePlayers.push(player);
                } else if (!telegram) {
                    // Если нет Telegram, добавляем как уникального (но это редко)
                    uniquePlayers.push(player);
                }
            }

            return uniquePlayers;
        }

        // Проверить, существует ли уже анкета с таким Telegram
        async function checkDuplicateTelegram(telegram) {
            try {
                const players = await getAllPlayers();
                return players.some(player =>
                    (player.Telegram && player.Telegram.toLowerCase() === telegram.toLowerCase()) ||
                    (player['Telegram username'] && player['Telegram username'].toLowerCase() === telegram.toLowerCase())
                );
            } catch (error) {
                console.error("Ошибка при проверке дубликатов:", error);
                return false;
            }
        }

        // Добавить игрока в базу данных с проверкой дубликатов
        async function addPlayerToDatabase(playerData) {
            try {
                console.log("Добавляю игрока в базу:", playerData);

                // Проверяем, есть ли уже анкета с таким Telegram
                const telegram = playerData.Telegram || playerData['Telegram username'];
                if (telegram && telegram !== 'Не указан') {
                    const isDuplicate = await checkDuplicateTelegram(telegram);
                    if (isDuplicate) {
                        return {
                            success: false,
                            message: "❌ У вас уже есть анкета! Вы можете отредактировать существующую."
                        };
                    }
                }

                // Отправляем данные в базу
                const response = await fetch(SHEET_BEST_API.WRITE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(playerData)
                });

                if (!response.ok) {
                    throw new Error(`Ошибка сохранения: ${response.status}`);
                }

                const result = await response.json();
                console.log("Игрок успешно добавлен:", result);

                // Добавляем в множество для локальной проверки дубликатов
                if (telegram) {
                    playerDuplicates.add(telegram.toLowerCase());
                }

                return { success: true, message: "✅ Анкета успешно сохранена!" };

            } catch (error) {
                console.error("Ошибка при добавлении игрока:", error);

                // Если не удалось сохранить в базу, сохраняем локально
                savePlayerLocally(playerData);
                return {
                    success: true,
                    message: "✅ Анкета сохранена локально (база временно недоступна)"
                };
            }
        }

        // Сохранить игрока локально (запасной вариант)
        function savePlayerLocally(playerData) {
            try {
                const existingPlayers = JSON.parse(localStorage.getItem('lfgBridgePlayers') || '[]');

                // Проверяем локальные дубликаты
                const telegram = playerData.Telegram || playerData['Telegram username'];
                const isLocalDuplicate = existingPlayers.some(player =>
                    (player.Telegram && player.Telegram.toLowerCase() === telegram.toLowerCase())
                );

                if (!isLocalDuplicate) {
                    existingPlayers.push({
                        ...playerData,
                        id: Date.now(),
                        local: true
                    });

                    localStorage.setItem('lfgBridgePlayers', JSON.stringify(existingPlayers));
                    console.log("Игрок сохранен локально:", playerData);

                    if (telegram) {
                        playerDuplicates.add(telegram.toLowerCase());
                    }
                }
            } catch (e) {
                console.error("Ошибка при локальном сохранении:", e);
            }
        }

        // Получить локальных игроков
        function getLocalPlayers() {
            try {
                const players = JSON.parse(localStorage.getItem('lfgBridgePlayers') || '[]');
                // Фильтруем дубликаты и локальные записи
                return removeDuplicates(players.filter(p => p.local));
            } catch (e) {
                console.error("Ошибка при загрузке локальных игроков:", e);
                return [];
            }
        }

        // ==============================================
        // ОСНОВНЫЕ ФУНКЦИИ ПРИЛОЖЕНИЯ
        // ==============================================

        // Сохранить профиль
        async function saveProfile() {
            // Получаем данные из Telegram
            const tg = window.Telegram.WebApp;
            let telegramUsername = "";

            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const tgUser = tg.initDataUnsafe.user;
                userProfile.name = tgUser.first_name || "Игрок";
                userProfile.userId = tgUser.id;

                // Берем username из Telegram
                telegramUsername = tgUser.username ? tgUser.username : "";
            }

            // Получаем название игры
            const gameName = gameData[userProfile.game] ? gameData[userProfile.game].name : userProfile.game;
            const goalName = getGoalName(userProfile.goal);

            // Формируем данные для сохранения (правильные колонки)
            const playerData = {
                "Имя": userProfile.name,
                "Игра": gameName,
                "Ранг": userProfile.rank,
                "Роль": userProfile.role,
                "Цель": goalName,
                "Telegram": telegramUsername ? `@${telegramUsername}` : "Не указан",
                "Дата создания": new Date().toLocaleString('ru-RU')
            };

            // Сохраняем профиль локально
            userProfile.createdAt = new Date().toISOString();
            userProfile.telegram = telegramUsername ? `@${telegramUsername}` : "";
            localStorage.setItem('lfgBridgeProfile', JSON.stringify(userProfile));

            // Отправляем в базу данных
            const result = await addPlayerToDatabase(playerData);
            return result;
        }

        // Загрузить профиль
        function loadProfile() {
            try {
                const savedProfile = localStorage.getItem('lfgBridgeProfile');
                if (savedProfile) {
                    userProfile = JSON.parse(savedProfile);
                    console.log("Профиль загружен:", userProfile);
                    return true;
                }
            } catch (e) {
                console.error("Ошибка при загрузке профиля:", e);
            }
            return false;
        }

        // Проверить, заполнена ли анкета
        function isProfileComplete() {
            return userProfile.game && userProfile.rank && userProfile.role && userProfile.goal;
        }

        // Получить название цели игры
        function getGoalName(goalKey) {
            const goals = {
                'ranked': 'Ранговые игры',
                'fun': 'Для развлечения',
                'training': 'Обучение/тренировка',
                'tournament': 'Турниры/соревнования'
            };
            return goals[goalKey] || goalKey;
        }

        // ==============================================
        // ФУНКЦИИ ДЛЯ РАБОТЫ С ЭКРАНАМИ
        // ==============================================

        // Показать экран
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });

            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
            }

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-screen') === screenId) {
                    item.classList.add('active');
                }
            });

            // Обновить данные на экране
            if (screenId === 'profile-screen') {
                updateProfileScreen();
            } else if (screenId === 'search-screen') {
                updateSearchScreen();
            } else if (screenId === 'form-screen') {
                updateFormScreen();
            }
        }

        // Обновить экран анкеты
        function updateFormScreen() {
            loadProfile();

            if (isProfileComplete()) {
                setSelectedOption('form-step-1', userProfile.game);
                setSelectedOption('form-step-2', userProfile.rank);
                setSelectedOption('form-step-3', userProfile.role);
                setSelectedOption('form-step-4', userProfile.goal);

                currentStep = 4;
                updateStepIndicator();
                showStep(4);
                document.getElementById('next-step-btn').textContent = 'Обновить анкету';
            } else {
                currentStep = 1;
                updateStepIndicator();
                showStep(1);
                document.getElementById('next-step-btn').textContent = 'Далее';
            }
        }

        // Обновить экран профиля
        async function updateProfileScreen() {
            const profileInfo = document.getElementById('profile-info');

            if (isProfileComplete()) {
                const gameName = gameData[userProfile.game] ? gameData[userProfile.game].name : userProfile.game;

                profileInfo.innerHTML = `
                    <h3>${userProfile.name}</h3>
                    <div class="player-details" style="margin-top: 15px;">
                        <div class="player-detail">🎮 ${gameName}</div>
                        <div class="player-detail">🏆 ${userProfile.rank}</div>
                        <div class="player-detail">👤 ${userProfile.role}</div>
                        <div class="player-detail">🎯 ${getGoalName(userProfile.goal)}</div>
                        <div class="player-detail">📞 ${userProfile.telegram || 'Не указан'}</div>
                    </div>
                    <p style="margin-top: 15px; color: #81c784;">
                        ✅ Ваша анкета сохранена в общей базе данных!
                    </p>
                `;

                document.getElementById('edit-profile-btn').classList.remove('hidden');
                document.getElementById('delete-profile-btn').classList.remove('hidden');
            } else {
                profileInfo.innerHTML = `
                    <p class="status info">У вас еще нет созданной анкеты. Заполните анкету на вкладке "Анкета".</p>
                `;

                document.getElementById('edit-profile-btn').classList.add('hidden');
                document.getElementById('delete-profile-btn').classList.add('hidden');
            }
        }

        // ==============================================
        // ФУНКЦИИ ДЛЯ РАБОТЫ С АНКЕТОЙ
        // ==============================================

        // Показать шаг анкеты
        function showStep(stepNumber) {
            document.querySelectorAll('.form-step').forEach(step => {
                step.classList.add('hidden');
            });

            const stepElement = document.getElementById(`form-step-${stepNumber}`);
            if (stepElement) {
                stepElement.classList.remove('hidden');
            }

            document.getElementById('prev-step-btn').classList.toggle('hidden', stepNumber === 1);

            const nextBtn = document.getElementById('next-step-btn');
            if (stepNumber === totalSteps) {
                nextBtn.textContent = isProfileComplete() ? 'Обновить анкету' : 'Сохранить анкету';
            } else {
                nextBtn.textContent = 'Далее';
            }

            if (stepNumber === 2) {
                loadRankOptions();
            } else if (stepNumber === 3) {
                loadRoleOptions();
            }
        }

        // Обновить индикатор шагов
        function updateStepIndicator() {
            for (let i = 1; i <= totalSteps; i++) {
                const stepElement = document.getElementById(`step-${i}`);
                if (stepElement) {
                    stepElement.classList.remove('active', 'completed');

                    if (i === currentStep) {
                        stepElement.classList.add('active');
                    } else if (i < currentStep) {
                        stepElement.classList.add('completed');
                    }
                }
            }
        }

        // Перейти к следующему шагу
        async function nextStep() {
            if (currentStep < totalSteps) {
                if (!isOptionSelected(currentStep)) {
                    showMessage('Пожалуйста, выберите вариант перед переходом к следующему шагу.', 'warning');
                    return;
                }

                currentStep++;
                updateStepIndicator();
                showStep(currentStep);
            } else {
                if (!isOptionSelected(currentStep)) {
                    showMessage('Пожалуйста, выберите вариант перед сохранением анкеты.', 'warning');
                    return;
                }

                // Сохраняем анкету
                const result = await saveProfile();

                if (result.success) {
                    showMessage(result.message, 'success');
                    setTimeout(() => {
                        showScreen('profile-screen');
                    }, 1500);
                } else {
                    showMessage(result.message, 'error');
                    if (result.message.includes("уже есть анкета")) {
                        // Если уже есть анкета, переходим в профиль
                        setTimeout(() => {
                            showScreen('profile-screen');
                        }, 2000);
                    }
                }
            }
        }

        // Вернуться к предыдущему шагу
        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepIndicator();
                showStep(currentStep);
            }
        }

        // Проверить, выбран ли вариант
        function isOptionSelected(step) {
            if (step === 1) return userProfile.game !== null;
            if (step === 2) return userProfile.rank !== null;
            if (step === 3) return userProfile.role !== null;
            if (step === 4) return userProfile.goal !== null;
            return false;
        }

        // Показать сообщение
        function showMessage(message, type = 'info') {
            const currentStepEl = document.getElementById(`form-step-${currentStep}`);
            if (!currentStepEl) return;

            const messageEl = document.createElement('div');
            messageEl.className = `status ${type}`;
            messageEl.textContent = message;
            messageEl.style.marginTop = '15px';

            const existingMessages = currentStepEl.querySelectorAll('.status');
            existingMessages.forEach(msg => msg.remove());

            currentStepEl.appendChild(messageEl);

            if (type !== 'success') {
                setTimeout(() => messageEl.remove(), 5000);
            }
        }

        // Установить выбранную опцию
        function setSelectedOption(stepContainerId, value) {
            const container = document.getElementById(stepContainerId);
            if (!container) return;

            container.querySelectorAll('.option').forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-value') === value) {
                    option.classList.add('selected');
                }
            });
        }

        // Загрузить опции рангов
        function loadRankOptions() {
            const rankOptions = document.getElementById('rank-options');
            rankOptions.innerHTML = '';

            if (!userProfile.game) {
                rankOptions.innerHTML = `
                    <div class="status warning">
                        Сначала выберите игру на шаге 1
                    </div>
                `;
                return;
            }

            if (userProfile.game && gameData[userProfile.game]) {
                gameData[userProfile.game].ranks.forEach(rank => {
                    const option = document.createElement('div');
                    option.className = 'option';
                    option.setAttribute('data-value', rank);
                    option.textContent = rank;

                    if (userProfile.rank === rank) {
                        option.classList.add('selected');
                    }

                    option.addEventListener('click', function() {
                        rankOptions.querySelectorAll('.option').forEach(opt => {
                            opt.classList.remove('selected');
                        });

                        this.classList.add('selected');
                        userProfile.rank = this.getAttribute('data-value');
                    });

                    rankOptions.appendChild(option);
                });
            }
        }

        // Загрузить опции ролей
        function loadRoleOptions() {
            const roleOptions = document.getElementById('role-options');
            roleOptions.innerHTML = '';

            if (!userProfile.game) {
                roleOptions.innerHTML = `
                    <div class="status warning">
                        Сначала выберите игру на шаге 1
                    </div>
                `;
                return;
            }

            if (userProfile.game && gameData[userProfile.game]) {
                gameData[userProfile.game].roles.forEach(role => {
                    const option = document.createElement('div');
                    option.className = 'option';
                    option.setAttribute('data-value', role);
                    option.textContent = role;

                    if (userProfile.role === role) {
                        option.classList.add('selected');
                    }

                    option.addEventListener('click', function() {
                        roleOptions.querySelectorAll('.option').forEach(opt => {
                            opt.classList.remove('selected');
                        });

                        this.classList.add('selected');
                        userProfile.role = this.getAttribute('data-value');
                    });

                    roleOptions.appendChild(option);
                });
            }
        }

        // ==============================================
        // ФУНКЦИИ ДЛЯ ПОИСКА ТИММЕЙТОВ
        // ==============================================

        // Найти тиммейтов
        async function findTeammates() {
            const searchStatus = document.getElementById('search-status');
            searchStatus.classList.remove('hidden');

            const searchResults = document.getElementById('search-results');
            searchResults.innerHTML = '';

            try {
                await new Promise(resolve => setTimeout(resolve, 800));

                if (!isProfileComplete()) {
                    searchResults.innerHTML = `
                        <div class="status info">
                            <p>Сначала заполните свою анкету, чтобы найти подходящих тиммейтов.</p>
                            <button id="go-to-form-btn" class="btn btn-small" style="margin-top: 10px;">Заполнить анкету</button>
                        </div>
                    `;

                    document.getElementById('go-to-form-btn').addEventListener('click', () => {
                        showScreen('form-screen');
                    });
                    return;
                }

                // Получаем всех игроков из базы данных (уже без дубликатов)
                const allPlayers = await getAllPlayers();

                // Добавляем локальных игроков
                const localPlayers = getLocalPlayers();
                const allPlayersCombined = [...allPlayers, ...localPlayers];

                const gameName = gameData[userProfile.game] ? gameData[userProfile.game].name : userProfile.game;
                const currentTelegram = userProfile.telegram || "";

                // Фильтруем игроков
                const matchedPlayers = allPlayersCombined.filter(player => {
                    // Пропускаем текущего пользователя
                    const playerTelegram = player.Telegram || player['Telegram username'] || '';
                    if (playerTelegram && currentTelegram &&
                        playerTelegram.toLowerCase() === currentTelegram.toLowerCase()) {
                        return false;
                    }

                    // Фильтруем по игре
                    if (player.Игра !== gameName) return false;

                    return true;
                });

                // Показываем результаты
                displaySearchResults(matchedPlayers, allPlayersCombined.length);

            } catch (error) {
                console.error("Ошибка при поиске:", error);
                searchResults.innerHTML = `
                    <div class="status error">
                        <p>Ошибка при поиске: ${error.message}</p>
                        <p>Попробуйте обновить страницу</p>
                    </div>
                `;
            } finally {
                searchStatus.classList.add('hidden');
            }
        }

        // Обновить экран поиска
        function updateSearchScreen() {
            const searchResults = document.getElementById('search-results');
            searchResults.innerHTML = '';
            document.getElementById('search-status').classList.add('hidden');
        }

        // Показать результаты поиска
        function displaySearchResults(players, totalCount) {
            const searchResults = document.getElementById('search-results');

            if (players.length === 0) {
                searchResults.innerHTML = `
                    <div class="status info">
                        <p>😔 Пока нет подходящих игроков. Будьте первым в вашей игре!</p>
                        <p><small>Всего игроков в системе: ${totalCount}</small></p>
                    </div>
                `;
                return;
            }

            // Добавляем статистику
            const stats = document.createElement('div');
            stats.className = 'status success';
            stats.innerHTML = `
                🎯 Найдено ${players.length} уникальных игроков из ${totalCount} в вашу игру
            `;
            searchResults.appendChild(stats);

            // Показываем каждого игрока
            players.forEach(player => {
                const playerCard = createPlayerCard(player);
                searchResults.appendChild(playerCard);
            });
        }

        // Создать карточку игрока
        function createPlayerCard(player) {
            const card = document.createElement('div');
            card.className = 'player-card';

            // Получаем Telegram username (пробуем разные варианты колонок)
            const telegram = player.Telegram || player['Telegram username'] || '';
            const hasContact = telegram && telegram !== 'Не указан' && telegram !== '@' && telegram !== '';

            // Получаем имя
            const name = player.Имя || player.Name || 'Аноним';
            const firstLetter = name ? name.charAt(0).toUpperCase() : '?';

            card.innerHTML = `
                <div class="player-avatar">${firstLetter}</div>
                <div class="player-info">
                    <div class="player-name">${name}</div>
                    <div class="player-details">
                        <div class="player-detail">🎮 ${player.Игра || player.Game || 'Не указано'}</div>
                        <div class="player-detail">🏆 ${player.Ранг || player.Rank || 'Не указан'}</div>
                        <div class="player-detail">👤 ${player.Роль || player.Role || 'Не указана'}</div>
                        <div class="player-detail">🎯 ${player.Цель || player.Goal || 'Не указана'}</div>
                    </div>
                </div>
                <button class="btn btn-small contact-btn" data-telegram="${telegram}">
                    ${hasContact ? '💬 Написать' : '📞 Нет контакта'}
                </button>
            `;

            return card;
        }

        // Открыть чат в Telegram
        function openTelegramChat(username) {
            if (!username || username === "Не указан" || username === '@' || username === '') {
                alert("У этого игрока не указан Telegram username");
                return;
            }

            // Убираем @ в начале если есть
            const cleanUsername = username.replace('@', '');

            const tg = window.Telegram.WebApp;
            if (tg.platform !== 'unknown') {
                tg.openTelegramLink(`https://t.me/${cleanUsername}`);
            } else {
                window.open(`https://t.me/${cleanUsername}`, '_blank');
            }
        }

        // ==============================================
        // ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ
        // ==============================================

        // Инициализация приложения
        async function initApp() {
            console.log("LFG Bridge инициализирован");

            // Инициализация Telegram Web App
            const tg = window.Telegram.WebApp;
            tg.expand();
            tg.ready();

            // Загружаем профиль
            loadProfile();

            // Предзагружаем данные для проверки дубликатов
            try {
                const players = await getAllPlayers();
                // Заполняем множество для быстрой проверки дубликатов
                players.forEach(player => {
                    const telegram = player.Telegram || player['Telegram username'];
                    if (telegram) {
                        playerDuplicates.add(telegram.toLowerCase());
                    }
                });
                console.log("Данные для проверки дубликатов загружены");
            } catch (error) {
                console.log("Не удалось загрузить данные для проверки дубликатов");
            }

            // Настройка обработчиков событий

            // Основные кнопки
            document.getElementById('start-btn').addEventListener('click', () => {
                showScreen('form-screen');
            });

            // Навигация
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    showScreen(item.getAttribute('data-screen'));
                });
            });

            // Анкета
            document.getElementById('next-step-btn').addEventListener('click', nextStep);
            document.getElementById('prev-step-btn').addEventListener('click', prevStep);

            // Выбор игры и цели
            document.querySelectorAll('#form-step-1 .option, #form-step-4 .option').forEach(option => {
                option.addEventListener('click', function() {
                    const container = this.closest('.form-step');
                    if (!container) return;

                    container.querySelectorAll('.option').forEach(opt => {
                        opt.classList.remove('selected');
                    });

                    this.classList.add('selected');
                    const value = this.getAttribute('data-value');

                    if (container.id === 'form-step-1') {
                        userProfile.game = value;
                        userProfile.rank = null;
                        userProfile.role = null;

                        if (currentStep === 2) loadRankOptions();
                        if (currentStep === 3) loadRoleOptions();
                    } else if (container.id === 'form-step-4') {
                        userProfile.goal = value;
                    }
                });
            });

            // Поиск
            document.getElementById('search-btn').addEventListener('click', findTeammates);
            document.getElementById('refresh-search-btn').addEventListener('click', findTeammates);

            // Профиль
            document.getElementById('edit-profile-btn').addEventListener('click', () => {
                showScreen('form-screen');
            });

            document.getElementById('delete-profile-btn').addEventListener('click', () => {
                if (confirm('Удалить вашу анкету из локального хранилища?')) {
                    localStorage.removeItem('lfgBridgeProfile');
                    userProfile = {
                        game: null,
                        rank: null,
                        role: null,
                        goal: null,
                        name: "Игрок",
                        telegram: "",
                        userId: null,
                        createdAt: null
                    };
                    updateProfileScreen();
                    showMessage('Анкета удалена', 'success');
                }
            });

            // Кнопки "Написать"
            document.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('contact-btn')) {
                    const telegramUsername = e.target.getAttribute('data-telegram');
                    openTelegramChat(telegramUsername);
                }
            });

            // Показать приветственный экран
            showScreen('welcome-screen');

            console.log("Приложение готово к работе");
        }

        // Запустить приложение
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>